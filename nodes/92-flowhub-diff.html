<script type="text/javascript">
  (function(){

    function escapeHtml(string) {
      return String(string).replace(/[&<>"'`=\/]/g, function fromEntityMap(s) {
        return entityMap[s];
      });
    }

    function loadScript(url, callback) {
          var script = document.createElement("script")
          script.type = "text/javascript";

          if (script.readyState) {  // only required for IE <9
              script.onreadystatechange = function () {
                  if (script.readyState === "loaded" || script.readyState === "complete") {
                      script.onreadystatechange = null;
                      if (callback) { callback(); }
                  }
              };
          } else {  //Others
              script.onload = function () {
                  if (callback) { callback(); }
              };
          }

          script.src = url;
          document.getElementsByTagName("head")[0].appendChild(script);
      };

    var entityMap = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#39;',
      '/': '&#x2F;',
      '`': '&#x60;',
      '=': '&#x3D;'
    };

    var descMap = {
      'z': "Flow Tab Id",
      'g': "Group Id",
      'd': "Disabled",
    };

    function attrDesc(nme) {
      return descMap[nme] ? " <i style='font-size: 80%;'>(" + descMap[nme] + ")</i>" : "";
    }

    function createDiff(ndeV1, ndeV2) {
      var diffDetails = [];
      var changedAttrs = [];

      Object.keys(ndeV2).forEach(function (nme) {
        if ( Object.keys(ndeV1).indexOf(nme) < 0 ) {
          var txt = typeof ndeV2[nme] == "object" ? JSON.stringify(ndeV2[nme]) : ndeV2[nme];
          diffDetails.push("<tr class='dv-removed'><th>" + nme + attrDesc(nme) + "</th><td><i>MISSING</i></td><td><code>" + escapeHtml(txt) + "</code></td></tr>")
          changedAttrs.push(nme)
        }
      });

      Object.keys(ndeV1).forEach(function (nme) {
        if (Object.keys(ndeV2).indexOf(nme) < 0) {
          var txt = typeof ndeV1[nme] == "object" ? JSON.stringify(ndeV1[nme]) : ndeV1[nme];
          diffDetails.push("<tr class='dv-added'><th>" + nme + attrDesc(nme) + "</th><td><code>" + escapeHtml(txt) +"</code></td><td><i>ADDED</i></td></tr>")
          changedAttrs.push(nme)
        }
      });

      Object.keys(ndeV1).forEach(function (nme) {
        if (Object.keys(ndeV2).indexOf(nme) > -1) {
          if ( JSON.stringify(ndeV1[nme]) !== JSON.stringify(ndeV2[nme]) ) {
            let span = null;
            let diff = undefined;
            changedAttrs.push(nme)

            try {
              diff = Diff.diffLines(ndeV2[nme], ndeV1[nme])
            } catch (e) {
              diff = Diff.diffLines(JSON.stringify(ndeV2[nme],undefined,1), JSON.stringify(ndeV1[nme],undefined,1))
            }
            const fragment = document.createDocumentFragment();

            diff.forEach((part) => {
              // green for additions, red for deletions
              const color = part.added ? 'green' : part.removed ? 'red' : '#040506';

              span = document.createElement('pre');
              span.setAttribute('class','dv-pre-elem');
              span.style.color = color;
              span.appendChild(document.createTextNode(part.value));
              span.appendChild(document.createElement('br'));
              fragment.appendChild(span);
            });

            var row = document.createElement('tr');
            row.setAttribute('class',"dv-differ")
            var cell = document.createElement('th')
            cell.appendChild(document.createTextNode(nme))
            if (descMap[nme]) {
              var itl = document.createElement('i');
              itl.style["font-size"] = "80%"
              itl.appendChild(document.createTextNode("(" + descMap[nme]+")"))
              cell.appendChild(itl)
            }
            row.append(cell);

            cell = document.createElement('td')
            cell.setAttribute('colspan', '2')
            cell.append( fragment)

            row.append(cell)
            diffDetails.push(row.outerHTML)
          } else {
            diffDetails.push("<tr><th>" + nme + "</th><td><code>" + escapeHtml(ndeV1[nme]) + "</code></td><td><code>" + escapeHtml(ndeV2[nme]) + "</code></td></tr>")
          }
        }
      });
      
      return { 
        html: diffDetails.join(""),
        visualOnly: changedAttrs.filter( d => d != 'x' && d != 'w' && d != 'y' && d != 'h').length == 0
      }
    }


    function getFlowDataFromCurrentWorkspace() {
      /******
       ** Code taken from Node-RED code base:
       **
       ** https://github.com/node-red/node-red/blob/e8ddee24a9944e57d186f02b081295c56a45b67c/packages/node_modules/%40node-red/editor-client/src/js/ui/clipboard.js#L710-L723
       **
       **/
      var activeWorkspace = RED.workspaces.active();
      var nodes = RED.nodes.groups(activeWorkspace);

      nodes = nodes.concat(RED.nodes.junctions(activeWorkspace));
      nodes = nodes.concat(RED.nodes.filterNodes({z:activeWorkspace}));

      RED.nodes.eachConfig(function(n) {
        if (n.z === RED.workspaces.active() && n._def.hasUsers === false) {
          // Grab any config nodes scoped to this flow that don't
          // require any flow-nodes to use them
          nodes.push(n);
        }
      });

      var parentNode = RED.nodes.workspace(
        activeWorkspace
      ) || RED.nodes.subflow(activeWorkspace);

      nodes.unshift(parentNode);

      return RED.nodes.createExportableNodeSet(nodes);
    }

    function doSubmission(node, flowdata) {

      var activeWorkspace = RED.workspaces.active();
      
      RED.notify("Flow Comparison Triggered", {
          type: "warning",
          id: "FlowHubDiff",
          timeout: 2000
      });

      $.ajax({
        url:         "FlowHubDiff/" + node.id,
        type:        "POST",
        contentType: "application/json; charset=utf-8",

        data: JSON.stringify({
          flowid:         activeWorkspace,
          flowhub:        "submission from " + node.id,
          flowdata:       flowdata||{},
          flowlabel:      RED.nodes.workspace(activeWorkspace).label,
          incflowhubpull: $("#node-input-incflowhubpull").is(":checked")
        }),

        success: function (resp) {
          var items = [];
          var nodeItemMap = {};

          resp.changes.forEach( function (nde) {
            var nId = nde.id;

            if ( nde.type == "deleted") {
              nodeItemMap[nId] = {
                label:    nde.oldObj.name || nde.oldObj.type,
                icon:     "fa fa-times",
                class:    "",
                diffcontent: createDiff({}, nde.oldObj).html,
                sublabel: nde.type,
                selected: false,
                checkbox: false,
                children: undefined
              };

              items.push(nodeItemMap[nId]);
              return;
            }

            if ( nde.type == "added") {
              nodeItemMap[nId] = {
                label:    nde.newObj.name || nde.newObj.type,
                icon:     "fa fa-check",
                class:    "",
                diffcontent: createDiff(nde.newObj, {}).html,
                sublabel: nde.type,
                selected: false,
                checkbox: false,
                children: undefined
              };

              items.push(nodeItemMap[nId]);
              return;
            }

            if ( nde.oldObj.type == "tab" || nde.oldObj.type == "group" || nde.oldObj.type == "junction" ) {
              nodeItemMap[nId] = {
                label:    nde.oldObj.name || nde.oldObj.type,
                icon:     "fa fa-times",
                class:    "",
                diffcontent: createDiff(nde.newObj, nde.oldObj).html,
                sublabel: nde.type + " - " + nde.oldObj.type,
                selected: false,
                checkbox: false,
                children: undefined
              };

              items.push(nodeItemMap[nId]);
              return;
            }

            var n = RED.nodes.node(nId);
            if ( !n ) {
              console.log( "Node not found", nde)
            }
            
            var nodeDef = RED.nodes.getType(n.type);
            var label;

            if (nodeDef) {
              var l = nodeDef.label;
              label = (typeof l === "function" ? l.call(n) : l)||"";
            }

            if (!nodeDef || !label) {
              label = n.type;
            }

            var diffContent = createDiff(nde.newObj, nde.oldObj);
            nodeItemMap[n.id] = {
              node:     n,
              label:    label,
              icon:     "fa " + (diffContent.visualOnly ? 'fa-eye' : 'fa-pencil'),
              class:    "",
              diffcontent: diffContent.html,
              sublabel: nde.type,
              selected: false,
              checkbox: false,
              children: undefined
            };

            items.push(nodeItemMap[n.id]);
          });

          if ( resp.ifurl ) {
            $('#node-input-flowhubdiff-svgcontainer').html(
                '<iframe width="100%" height="100%" src="' + resp.ifurl  + '" allow="clipboard-read; clipboard-write" style="border: none; min-height: 265px;"></iframe>'
              )
          }
          
          if ( items.length == 0 ) {
            $('#node-input-flowhubdiff-target-container-div').html("No changes")
          } else {
            node.dirList.treeList('empty');


            node.dirList.treeList('data',items.sort( (a,b) => a.sublabel > b.sublabel ));
          }
        },

        error: function (jqXHR, textStatus, errorThrown) {
          if (jqXHR.status == 404) {
            RED.notify("Node has not yet been deployed, please deploy.", "error");
          } else if (jqXHR.status == 405) {
            RED.notify("Not Allowed.", "error");
          } else if (jqXHR.status == 500) {
            RED.notify(node._("common.notification.error", {
              message: node._("inject.errors.failed")
            }), "error");
          } else if (jqXHR.status == 0) {
            RED.notify(node._("common.notification.error", {
              message: node._("common.notification.errors.no-response")
            }), "error");
          } else {
            RED.notify(node._("common.notification.error", {
              message: node._("common.notification.errors.unexpected", {
                status: jqXHR.status, message: textStatus }) }), "error");
          }
        }
      });
    }

    RED.nodes.registerType('FlowHubDiff',{
      color: '#44eeff',
      icon: "icons/diff.svg",
      category: 'flowhub',
      defaults: {
        name: { value: "" },
        incflowhubpull: { value: false },
      },

      inputs: 0,
      outputs: 0,

      label: function() {
        return (this.name || this._def.paletteLabel);
      },

      onpaletteadd: () => {
        loadScript("https://cdn.openmindmap.org/thirdparty/diff.min.js")        
      },

      oneditprepare: function() {
        var that = this;

        $('#node-input-push-flow-but').on('click', (e) => {
          e.preventDefault();
          doSubmission( that, getFlowDataFromCurrentWorkspace() )
        })

        this._resize = function() {
          var rows = $("#dialog-form>div:not(.node-input-target-list-row)");
          var height = $("#dialog-form").height();
          for (var i=0;i<rows.length;i++) {
            height -= $(rows[i]).outerHeight(true);
          }
          var editorRow = $("#dialog-form>div.node-input-target-list-row");
          editorRow.css("height",height+"px");
        };

        that.dirList = $("#node-input-flowhubdiff-target-container-div").css({
          width: "100%",
          height: "200px"
        }).treeList(
          {
            multi:false
          }
        ).on("treelistitemmouseover", function(e, item) {
          if ( item.node) {
            RED.workspaces.show(item.node.z,false,false,true);
            item.node.highlighted = true;
            RED.view.reveal(item.node.id,true)
            RED.view.redraw();
          }
        }).on("treelistitemmouseout", function(e, item) {

          if ( item.node ) {
            item.node.highlighted = false;
            item.node.dirty = true;
            RED.view.redraw();
          }
        }).on('treelistselect', function(event, item) {
          if ( item.diffcontent ) {
            $('#node-input-flowhubdiff-diffcontainer').html(item.diffcontent)
          } else {
            $('#node-input-flowhubdiff-diffcontainer').html("")
          }

          if ( item.node ) {
            RED.workspaces.show(item.node.z,false,false,true);
            // $('#node-dialog-cancel').trigger('click')

            var itm = item;
            setTimeout( () => {
              RED.sidebar.info.show();
              RED.view.redraw();
              RED.view.select(itm.node.id);
              RED.actions.invoke("core:move-selection-to-front");
            }, 735 );
          }
        });

        var search = $("#node-input-flowhubdiff-target-filter").searchBox({
          style: "compact",
          delay: 300,
          change: function() {
            var val = $(this).val().trim().toLowerCase();
            if (val === "") {
              that.dirList.treeList("filter", null);
              search.searchBox("count","");
            } else {
              var count = that.dirList.treeList("filter", function(item) {
                return item.label.toLowerCase().indexOf(val) > -1 || item.node.type.toLowerCase().indexOf(val) > -1
              });
              search.searchBox("count",count+" / "+items.length);
            }
          }
        });
      },

      oneditcancel: function() {
      },

      oneditsave: function() {
      },

      labelStyle: function() {
        return this.name?"node_label_italic":"";
      },
    });
  })();
</script>

<style>
.diff-viewer{
  overflow:scroll;
  background-color:rgb(244, 244, 244);
  border: 2px solid #000;
  height:80vh;
  padding: 20px;
  max-width: 90vw;
}

.dv-differ {
  background-color: rgba(244, 170, 23, 0.476) !important;
}

.dv-removed {
  background-color: rgb(203, 203, 38) !important;
}

.dv-added {
  background-color: rgb(86, 222, 120) !important;
}

.dv-pre-elem {
    page-break-inside: avoid;
    font-family: monospace;
    max-width: 100%;
    overflow: auto;
    display: block;
    word-wrap: break-word;
    margin: 0px !important;
}
</style>

<script type="text/html" data-template-name="FlowHubDiff">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name">Name</span></label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>


  <div class="form-row">
    <label for="node-input-incflowhubpull" style="min-width: 200px;">
              <span>Include FlowHubPull nodes?</span>
    </label>
    <input type="checkbox" id="node-input-incflowhubpull" style="display:inline-block; width:15px; vertical-align:baseline;">
  </div>

  <div class="form-row">
      <button id="node-input-push-flow-but"
              class="red-ui-button">Push Flow-Tab to FlowHub</button>
  </div>

  <div class="form-row">
      <a id="flowhubdiff-view-flow-link" style="color: blue; display: none;" target="_blank" href="">View Flow <i class="fa fa-external-link"></i></a>
  </div>

  <div class="form-row node-input-target-row node-input-target-list-row" style="position: relative; min-height: 100px">
    <div style="position: absolute; top: -30px; right: 0;">
      <input type="text" id="node-input-flowhubdiff-target-filter">
    </div>
  
    <div id="node-input-flowhubdiff-target-container-div" style="min-height: 100px"></div>
  </div>

  <div class="form-row" style="position: relative; min-height: 265px">
    <div id="node-input-flowhubdiff-svgcontainer"></div>
  </div>
  
    <div class="form-row" style="position: relative; min-height: 100px">
      <div id="node-input-flowhubdiff-diffcontainer" class="diff-viewer"></div>
    </div>
</script>

<script type="text/html" data-help-name="FlowHubDiff">
<p>Compare the current version of a flow with the latest version at FlowHub.org</p>
This node can be used to compare flows being modified locally with those stored on FlowHub. Difference are highlighted in the property panel.
</script>
