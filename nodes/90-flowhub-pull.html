<script type="text/javascript">
 (function(){
   function flowHubUpdateFlows(cb=null) {
     $.get( "https://api.flowhub.org/v1/flows?cb=" + new Date(), (e,d) => {
       var treeListItems = [];

       Object.keys( e.data ).forEach( function(key) {
         treeListItems.push( {
           label:    e.data[key].name,
           icon:     "fa fa-eye",
           flowid:   key,
           sublabel: key,
           selected: false,
           checkbox: false,
           children: undefined
         });
       });

       if ( cb ) {
         treeListItems.sort( (a,b) => {
           return a.label < b.label ? -1 : 1;
         });

         cb(treeListItems)
       };
     });
   };

   RED.nodes.registerType('FlowHubPull',{
     color: '#44eeff',
     icon: "icons/change.svg",
     category: 'flowhub',
     defaults: {
     },
     inputs: 0,
     outputs: 0,

     label: function() {
       return (this.name || this._def.paletteLabel);
     },

     onpaletteadd: () => {
     },

     oneditresize: function(size) {
       this._resize();
     },

     oneditprepare: function() {
       var dirList = $("#node-input-flowhubpull-target-container-div").css({
        width: "100%",
        height: "100%"
       }).treeList(
         {
           multi:false
         }
       ).on('treelistselect', function(event, item) {
         if ( item.flowid ) {
           $('#node-input-flowid').val(item.flowid);
         }
       });
       var items = [];

       this._resize = function() {
         var rows = $("#dialog-form>div:not(.node-input-target-list-row)");
         var height = $("#dialog-form").height();
         for (var i=0;i<rows.length;i++) {
           height -= $(rows[i]).outerHeight(true);
         }
         var editorRow = $("#dialog-form>div.node-input-target-list-row");
         editorRow.css("height",height+"px");
       };

       var search = $("#node-input-flowhubpull-target-filter").searchBox({
         style: "compact",
         delay: 300,
         change: function() {
           var val = $(this).val().trim().toLowerCase();
           if (val === "") {
             dirList.treeList("filter", null);
             search.searchBox("count","");
           } else {
             var count = dirList.treeList("filter", function(item) {
               return item.label.toLowerCase().indexOf(val) > -1 || item.sublabel.toLowerCase().indexOf(val) > -1
             });
             search.searchBox("count",count+" / "+items.length);
           }
         }
       });


       flowHubUpdateFlows((treeListItems) => {
         items = treeListItems;
         dirList.treeList('data', treeListItems);
       });

       $('#node-input-refresh-list-but').on('click', function(e) {
         e.preventDefault();

         setTimeout( () => {
           flowHubUpdateFlows((treeListItems) => {
             items = treeListItems;
             dirList.treeList('data', treeListItems);
           });
         }, 300);
       });

       $("#node-input-import-flow-but").on("click", function(e) {
         e.preventDefault();

         var notab = $('#node-input-notab').prop('checked');

         if ( $('#node-input-flowid').val().trim() == "" ||
              !$('#node-input-flowid').val() ) {
           return RED.notify(RED._("notification.warning", {
             message: "FlowID not provided, doing nothing."
           }), "warning");
         }

         $('#node-dialog-cancel').trigger('click')

         $.get( "https://api.flowhub.org/v1/flows/" +
                $('#node-input-flowid').val() +
                "?cb=" + new Date(), function(e,d) {
                  RED.clipboard.import();
                  setTimeout( () => {
                    var content = e;

                    if ( notab ) {
                      content = e.filter(function(o) {
                        return o.type != "tab"
                      });
                    }

                    $('#red-ui-clipboard-dialog-import-text').val(
                      JSON.stringify(content)
                    ).trigger("paste");
                  }, 300);
                });
       });
     },

     oneditcancel: function() {
     },

     oneditsave: function() {
     },

     labelStyle: function() {
       return this.name?"node_label_italic":"";
     },
   });
 })();
</script>

<script type="text/html" data-template-name="FlowHubPull">
    <div class="form-row">
        <input type="text" id="node-input-flowid"
               style="display:inline-block; width:70%px; vertical-align:baseline;"
               placeholder="FlowId to Import">
        <button id="node-input-import-flow-but"
                class="red-ui-button">Import Flow</button>
    </div>

    <div class="form-row">
      <label for="node-input-notab">
        <span>No Flow Tab?</span>
      </label>
      <input type="checkbox" id="node-input-notab"
             style="display:inline-block; width:15px; vertical-align:baseline;">
    </div>

    <div class="form-row node-input-target-row">
        <button id="node-input-refresh-list-but"
                class="red-ui-button">Refresh</button>
    </div>

    <div class="form-row node-input-target-row node-input-target-list-row"
         style="position: relative; min-height: 100px">
        <div style="position: absolute; top: -30px; right: 0px;">
            <input type="text" id="node-input-flowhubpull-target-filter">
        </div>

        <div id="node-input-flowhubpull-target-container-div"></div>
    </div>
</script>

<script type="text/html" data-help-name="FlowHubPull">
    <p>
        Import Flows from FlowHub.org. Opens the flow import dialog
        with flow data. Flow can be imported into a new tab or the
        existing tab.
    </p>
</script>
