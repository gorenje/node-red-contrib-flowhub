<script type="text/javascript">
  (function(){

    function getFlowDataFromCurrentWorkspace() {
      /******
       ** Code taken from Node-RED code base:
       **
       ** https://github.com/node-red/node-red/blob/e8ddee24a9944e57d186f02b081295c56a45b67c/packages/node_modules/%40node-red/editor-client/src/js/ui/clipboard.js#L710-L723
       **
       **/
      var activeWorkspace = RED.workspaces.active();
      var nodes = RED.nodes.groups(activeWorkspace);

      nodes = nodes.concat(RED.nodes.junctions(activeWorkspace));
      nodes = nodes.concat(RED.nodes.filterNodes({z:activeWorkspace}));

      RED.nodes.eachConfig(function(n) {
        if (n.z === RED.workspaces.active() && n._def.hasUsers === false) {
          // Grab any config nodes scoped to this flow that don't
          // require any flow-nodes to use them
          nodes.push(n);
        }
      });

      var parentNode = RED.nodes.workspace(
        activeWorkspace
      ) || RED.nodes.subflow(activeWorkspace);

      nodes.unshift(parentNode);

      return RED.nodes.createExportableNodeSet(nodes);
    }

    function doSubmission(node, flowdata) {

      var activeWorkspace = RED.workspaces.active();

      $.ajax({
        url:         "FlowHubPush/" + node.id,
        type:        "POST",
        contentType: "application/json; charset=utf-8",
        data: JSON.stringify({
          flowid:    activeWorkspace,
          flowhub:   "submission from " + node.id,
          flowdata:  flowdata||{},
          flowlabel: RED.nodes.workspace(activeWorkspace).label
        }),

        success: function (resp) {
          RED.notify("Submission triggered", {
            type: "warning",
            id: "FlowHubPush",
            timeout: 2000
          });
        },

        error: function (jqXHR, textStatus, errorThrown) {
          if (jqXHR.status == 404) {
            RED.notify("Node has not yet been deployed, please deploy.", "error");
          } else if (jqXHR.status == 405) {
            RED.notify("Not Allowed.", "error");
          } else if (jqXHR.status == 500) {
            RED.notify(node._("common.notification.error", {
              message: node._("inject.errors.failed")
            }), "error");
          } else if (jqXHR.status == 0) {
            RED.notify(node._("common.notification.error", {
              message: node._("common.notification.errors.no-response")
            }), "error");
          } else {
            RED.notify(node._("common.notification.error", {
              message: node._("common.notification.errors.unexpected", {
                status: jqXHR.status, message: textStatus }) }), "error");
          }
        }
      });
    }

    RED.nodes.registerType('FlowHubPush',{
      color: '#44eeff',
      icon: "icons/change.svg",
      category: 'flowhub',
      defaults: {
        apiToken: {
          value: "FLOWHUB_API_TOKEN",
        },
        apiTokenType: {
          value: "env",
        },
        fullname: { value: "" },
        email: { email: "" },
        name: { value: "" },
        incflowhubpull: { value: false },
      },

      /*
       * Having input would allow this to be triggered by a cron or
       * inject. It's possible using RED.comms but is this something
       * that should be triggered automagically? For now, no.
       */
      inputs: 0,
      outputs: 0,

      label: function() {
        return (this.name || this._def.paletteLabel);
      },

      onpaletteadd: () => {
      },

      oneditprepare: function() {
        $("#node-input-apiToken").typedInput({
          types:["env", "msg", "flow","global", "cred"],
          typeField: "#node-input-apiTokenType"
        });

        var that = this;
        $('#node-input-push-flow-but').on('click', (e) => {
          e.preventDefault();
          doSubmission( that, getFlowDataFromCurrentWorkspace() )
        })
      },

      oneditcancel: function() {
      },

      oneditsave: function() {
      },

      labelStyle: function() {
        return this.name?"node_label_italic":"";
      },
    });
  })();
</script>

<script type="text/html" data-template-name="FlowHubPush">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name">Name</span></label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>

  <div class="form-row">
    <hr />
  </div>

  <div class="form-row">
    <label for="node-input-apiToken">
      <i class="fa fa-tag"></i>
      FlowHub API Token
    </label>
    <input type="text" id="node-input-apiToken">
    <input type="hidden" id="node-input-apiTokenType">
  </div>

  <div class="form-row">
      Api Token can be obtained <a style="color: blue;" href="mailto:api.token@flowhub.org?subject=API%20Token%20Request">upon request <i class="fa fa-external-link"></i></a>.
  </div>

  <div class="form-row">
      Alternatively provide your email and full name to submit the current flow.<br>
      All submissions will be reviewed at GitHub and either merged or dropped.<br>
      Your <b>email and name</b> will be attached to the commit added to <br>
      the <a style="color: blue;" target="_blank" href="https://github.com/gorenje/flows.flowhub.org">FlowHub repository <i class="fa fa-external-link"></i></a>
  </div>

  <div class="form-row">
    <label for="node-input-email">
      <i class="fa fa-tag"></i>
      Email
    </label>
    <input type="text" id="node-input-email"
           placeholder="john.smith@example.com">
  </div>

  <div class="form-row">
    <label for="node-input-fullname">
      <i class="fa fa-tag"></i>
      Name
    </label>
    <input type="text" id="node-input-fullname"
           placeholder="Firstname Surname">
  </div>

  <div class="form-row">
      All submissions must be verified by email. After submission you<br>
      will recieve an email to <b>confirm your submission</b>.
  </div>

  <div class="form-row">
      <b>License:</b><br><br>
      All flows submitted are licensed under a copyleft <a style="color: blue;" target="_blank" href="https://raw.githubusercontent.com/gorenje/flows.flowhub.org/main/LICENSE">license <i class="fa fa-external-link"></i></a>,<br>
      that grants complete do-anything-but-not-evil permission to the user<br>
      and provides no warranty in case of failure nor guarantee of success.
  </div>

  <div class="form-row">
    <hr/>
  </div>

  <div class="form-row">
    <label for="node-input-incflowhubpull" style="min-width: 200px;">
              <span>Include FlowHubPull nodes?</span>
    </label>
    <input type="checkbox" id="node-input-incflowhubpull" style="display:inline-block; width:15px; vertical-align:baseline;">
  </div>

  <div class="form-row">
      <button id="node-input-push-flow-but"
              class="red-ui-button">Push Flow-Tab to FlowHub</button>
  </div>
</script>

<script type="text/html" data-help-name="FlowHubPush">
  <p>
      Push current flow tab to FlowHub.org.
      FlowHub nodes are ignored when flow-tabs are pushed to FlowHub.
      Flow tabs are exported as they <b>are in the editor</b>. What you see
      is what you export, the deployed flow might differ. This allows flows to
      be modified <b>without</b> having to be deployed.
  </p>

  <h3>Outputs</h3>
  <dl class="message-properties">
      <dt>payload
          <span class="property-type">object</span>
      </dt>
      <dd>the result of submission to FlowHub. Contains nothing of major
          interest.</dd>
  </dl>

  <h3>Details</h3>
  <p>
      FlowHubPush is the twin to the FlowHubPull node and is responsible for
      uploading the current flow tab to FlowHub. The Flow tab ID is used as
      identifier. The current flow tab in which the FlowHubPush node is
      located will be uploaded.
  </p>
  <p>
      FlowHubPush can be dragged into the flow, the button can be pressed to
      push the flow to FlowHub. Although for the button to be active, the
      flow has to be deployed at least once.
  </p>
  <p>
      Documentation on the flow should be included in the info box of the
      flow. Double click on the flow tab opens the property window and
      that's the documentation that will be hosted at FlowHub. Please provide
      documentation otherwise or a flow that is so simple to understand
      that it requires no documentation!
  </p>

  <p>
      Submission can either be done using an API token or using an email
      and full name. See the property tab for details on the usage of this
      service.
  </p>
</script>
